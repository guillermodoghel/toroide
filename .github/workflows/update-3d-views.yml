name: Update 3D Model Display

on:
  push:
    branches: [main]
    paths:
      - '**.3dm'
      - '.github/workflows/update-3d-views.yml'
      - 'README.md'
  schedule:
    # Run weekly to keep timestamps fresh
    - cron: '0 0 * * 0'

jobs:
  update-display:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Get current date
        id: date
        run: |
          echo "current_date=$(date +"%Y-%m-%d")" >> $GITHUB_OUTPUT
          echo "current_datetime=$(date +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_OUTPUT
          
      - name: Find 3DM file
        id: model
        run: |
          MODEL_FILE=$(find . -name "*.3dm" -type f | head -1)
          if [ -n "$MODEL_FILE" ]; then
            echo "model_path=$MODEL_FILE" >> $GITHUB_OUTPUT
            echo "model_name=$(basename "$MODEL_FILE")" >> $GITHUB_OUTPUT
            echo "model_size=$(du -h "$MODEL_FILE" | cut -f1)" >> $GITHUB_OUTPUT
          else
            echo "No .3dm file found"
            exit 1
          fi
          
      - name: Update README.md
        env:
          CURRENT_DATE: ${{ steps.date.outputs.current_date }}
          CURRENT_DATETIME: ${{ steps.date.outputs.current_datetime }}
          MODEL_NAME: ${{ steps.model.outputs.model_name }}
          MODEL_SIZE: ${{ steps.model.outputs.model_size }}
        run: |
          cat > README.md << 'EOF'
          # Toroide 3D Model
          
          This repository contains a 3D model of a toroide (torus/donut shape) created in Rhino 3D.
          
          ## 3D Model Views
          
          <div align="center">
          
          ### Isometric View
          ![Isometric View](images/isometric.png)
          
          <table>
            <tr>
              <td align="center">
                <strong>Top View</strong><br/>
                <img src="images/top.png" alt="Top View" width="300"/>
              </td>
              <td align="center">
                <strong>Front View</strong><br/>
                <img src="images/front.png" alt="Front View" width="300"/>
              </td>
              <td align="center">
                <strong>Right View</strong><br/>
                <img src="images/right.png" alt="Right View" width="300"/>
              </td>
            </tr>
          </table>
          
          </div>
          
          ## Interactive 3D Viewing
          
          To view this model interactively:
          
          1. **Download the file**: [`${MODEL_NAME}`](${MODEL_NAME}) (${MODEL_SIZE})
          2. **Online viewers**:
             - [3DViewer.net](https://3dviewer.net/) - Upload and view in browser
             - [Online 3D Viewer](https://viewer.3dprintcloud.com/) - Another web-based option
          3. **Desktop software**:
             - Rhino 3D (native format)
             - FreeCAD (open source)
             - Blender (with import plugins)
          
          ## Model Information
          
          | Property | Value |
          |----------|-------|
          | **Format** | Rhino 3D (.3dm) |
          | **File Size** | ${MODEL_SIZE} |
          | **Last Updated** | ${CURRENT_DATE} |
          | **Views Generated** | ${CURRENT_DATETIME} |
          | **Type** | Parametric torus/donut shape |
          
          ## Files Structure
          
          ```
          toroide/
          ‚îú‚îÄ‚îÄ ${MODEL_NAME}           # Main 3D model file
          ‚îú‚îÄ‚îÄ images/                      # Rendered view images
          ‚îÇ   ‚îú‚îÄ‚îÄ front.png               # Front orthographic view
          ‚îÇ   ‚îú‚îÄ‚îÄ isometric.png           # Isometric (3/4) view
          ‚îÇ   ‚îú‚îÄ‚îÄ right.png               # Right side orthographic view
          ‚îÇ   ‚îî‚îÄ‚îÄ top.png                 # Top orthographic view
          ‚îî‚îÄ‚îÄ README.md                   # This documentation
          ```
          
          ## Technical Notes
          
          - The model is created and maintained in **Rhino 3D**
          - Static orthographic and isometric views are pre-rendered as PNG images
          - For the best interactive experience, download the `.3dm` file and open in compatible software
          - GitHub doesn't support native 3D file preview, but the static images provide comprehensive views
          
          ---
          
          <div align="center">
          <em>Documentation automatically updated on ${CURRENT_DATETIME}</em><br/>
          <em>üîÑ This README is refreshed automatically when the 3D model changes</em>
          </div>
          EOF
          
      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "üìù Update README with current model info
            
            - Updated timestamps to ${{ steps.date.outputs.current_date }}
            - Model: ${{ steps.model.outputs.model_name }} (${{ steps.model.outputs.model_size }})
            
            ü§ñ Auto-updated by GitHub Actions"
            git push
          fi